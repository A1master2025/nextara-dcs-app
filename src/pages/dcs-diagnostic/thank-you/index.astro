---
/**
 * Thank-you page (Tier 2 submit success)
 * Route: /dcs-diagnostic/thank-you/
 * Fires: nt_dcs_diag_submit_success (tier2) with sessionStorage dedupe
 */
import Layout from '../../../layouts/Layout.astro';
import Tier2Telemetry from '../../../components/Tier2Telemetry.astro';
---

<Layout>
  <main class="tier2-main" data-nt-page="dcs_diagnostic_thank_you">
    <section class="tier2-section">
      <div class="tier2-container">
        <h1 class="tier2-h1">Request received</h1>
        <p class="tier2-lead">Weâ€™ll follow up shortly.</p>
      </div>
    </section>

    <script is:inline>
      (function () {
        window.dataLayer = window.dataLayer || [];

        var KEY = "nt_dcs_diag_submit_success";
        var TIMEOUT_MS = 3000;
        var POLL_MS = 50;
        var elapsed = 0;

        function once(key, fn) {
          try {
            if (sessionStorage.getItem(key)) return;
            sessionStorage.setItem(key, "1");
          } catch (e) {}
          fn();
        }

        function hasSystemReady() {
          try {
            for (var i = window.dataLayer.length - 1; i >= 0; i--) {
              if (window.dataLayer[i] && window.dataLayer[i].event === "nt_system_ready") return true;
            }
          } catch (e) {}
          return false;
        }

        function fire() {
          once(KEY, function () {
            window.dataLayer.push({
              event: "nt_dcs_diag_submit_success",
              nt_event_source: "tier2",
              form_name: "dcs-diagnostic",
              page_path: location.pathname,
              page_title: document.title
            });
          });
        }

        function wait() {
          if (hasSystemReady()) {
            fire();
            return;
          }
          if (elapsed < TIMEOUT_MS) {
            elapsed += POLL_MS;
            setTimeout(wait, POLL_MS);
          }
          // fail-closed on readiness timeout
        }

        wait();
      })();
    </script>

    <Tier2Telemetry />
  </main>
</Layout>
