---
import Layout from "../layouts/Layout.astro";
import Tier2Telemetry from "../components/Tier2Telemetry.astro";
---

<Layout
  title="DCS Diagnostic | NexTara"
  description="Run your Digital Credibility Score diagnostic. Discover how your digital presence scores across credibility, trust, and machine readability."
  robots="noindex,follow"
>

  <Tier2Telemetry />
  <main data-nt-section="diagnostic" data-nt-page="dcs_diagnostic">
    <section class="diagnostic-hero">
      <h1>DCS Diagnostic</h1>
      <p>Discover how your digital presence scores across credibility, trust, and machine readability.</p>
    </section>

    <section class="diagnostic-form-section" data-nt-section="diagnostic_form">
      <form
        id="dcs-form"
        name="dcs-diagnostic"
        method="POST"
        data-netlify="true"
        data-netlify-honeypot="bot-field"
        action="/dcs-diagnostic/thank-you/"
        data-nt-form="dcs_diagnostic"
      >
        <input type="hidden" name="form-name" value="dcs-diagnostic" />

        <p class="hidden" aria-hidden="true" style="display:none;">
          <label>
            Don't fill this out:
            <input name="bot-field" tabindex="-1" autocomplete="off" />
          </label>
        </p>

        <div class="form-field">
          <label for="dcs-website">Website</label>
          <input
            type="url"
            id="dcs-website"
            name="website"
            autocomplete="url"
            required
            placeholder="https://yourwebsite.com"
            data-nt-field="website"
          />
        </div>

        <div class="form-field">
          <label for="dcs-name">Name</label>
          <input
            type="text"
            id="dcs-name"
            name="name"
            autocomplete="name"
            required
            placeholder="Your name"
            data-nt-field="name"
          />
        </div>

        <div class="form-field">
          <label for="dcs-email">Email</label>
          <input
            type="email"
            id="dcs-email"
            name="email"
            autocomplete="email"
            required
            placeholder="you@example.com"
            data-nt-field="email"
          />
        </div>

        <div id="dcs-form-error" class="form-error" style="display:none;" role="alert"></div>

        <button
          type="submit"
          id="dcs-submit-btn"
          data-nt-event="cta_conversion"
          data-nt-cta="dcs_diagnostic_submit"
        >
          Run Diagnostic
        </button>
      </form>
    </section>
  </main>
</Layout>

<script is:inline>
(function() {
  var SESSION_KEY = "nt_dcs_diag_view_fired";

  function isSystemReady() {
    if (window.__NT_SYSTEM_READY_EMITTED__ === true) return true;
    if (window.dataLayer && Array.isArray(window.dataLayer)) {
      for (var i = 0; i < window.dataLayer.length; i++) {
        if (window.dataLayer[i] && window.dataLayer[i].event === "nt_system_ready") {
          return true;
        }
      }
    }
    return false;
  }

  function pushViewEvent() {
    if (typeof sessionStorage !== "undefined" && sessionStorage.getItem(SESSION_KEY)) {
      return;
    }
    if (window.dataLayer) {
      window.dataLayer.push({
        event: "nt_dcs_diag_view",
        nt_event_source: "tier2",
        page_path: "/dcs-diagnostic/"
      });
      if (typeof sessionStorage !== "undefined") {
        sessionStorage.setItem(SESSION_KEY, "1");
      }
    }
  }

  function waitForReady() {
    if (isSystemReady()) {
      pushViewEvent();
      return;
    }
    var attempts = 0;
    var maxAttempts = 30;
    var interval = setInterval(function() {
      attempts++;
      if (isSystemReady()) {
        clearInterval(interval);
        pushViewEvent();
      } else if (attempts >= maxAttempts) {
        clearInterval(interval);
        pushViewEvent();
      }
    }, 100);
  }

  if (document.readyState === "complete") {
    waitForReady();
  } else {
    window.addEventListener("load", waitForReady);
  }
})();
</script>

<script is:inline>
(function() {
  var form = document.getElementById("dcs-form");
  var submitBtn = document.getElementById("dcs-submit-btn");
  var errorDiv = document.getElementById("dcs-form-error");

  if (!form) return;

  form.addEventListener("submit", function(e) {
    e.preventDefault();

    var formData = new FormData(form);
    submitBtn.disabled = true;
    submitBtn.textContent = "Submitting...";
    errorDiv.style.display = "none";

    fetch("/", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams(formData).toString()
    })
    .then(function(response) {
      if (!response.ok) {
        throw new Error("Network response was not ok");
      }
      var thankYouPath = "/dcs-diagnostic/thank-you/";
      var params = new URLSearchParams(window.location.search);
      var gtmParams = [];
      if (params.get("gtm_debug")) gtmParams.push("gtm_debug=" + encodeURIComponent(params.get("gtm_debug")));
      if (params.get("gtm_auth")) gtmParams.push("gtm_auth=" + encodeURIComponent(params.get("gtm_auth")));
      if (params.get("gtm_preview")) gtmParams.push("gtm_preview=" + encodeURIComponent(params.get("gtm_preview")));
      if (gtmParams.length > 0) {
        thankYouPath += "?" + gtmParams.join("&");
      }
      window.location.assign(thankYouPath);
    })
    .catch(function(error) {
      submitBtn.disabled = false;
      submitBtn.textContent = "Run Diagnostic";
      errorDiv.textContent = "Submission failed. Please try again.";
      errorDiv.style.display = "block";
      console.error("Form submission error:", error);
    });
  });
})();
</script>