---
/**
 * src/pages/dcs-diagnostic.astro
 * Tier-2 DCS Diagnostic
 *
 * Critical behavior:
 * - Native form POST is intercepted (prevents POST->/thank-you/ 404 + GTM Preview drop)
 * - Netlify Forms submission via fetch("/") using x-www-form-urlencoded
 * - Redirect to /dcs-diagnostic/thank-you/ via GET (preserves GTM preview querystring)
 * - View telemetry: nt_dcs_diag_view (gated by nt_system_ready, session dedupe)
 */
import Layout from '../layouts/Layout.astro';
import Tier2Telemetry from '../components/Tier2Telemetry.astro';
---

<Layout>
  <main class="tier2-main" data-nt-page="dcs_diagnostic">
    <!-- DCS Diagnostic Form (Netlify Forms) -->
    <form
      id="dcs-diagnostic-form"
      name="dcs-diagnostic"
      method="POST"
      data-netlify="true"
      data-netlify-honeypot="bot-field"
      action="/dcs-diagnostic/thank-you/"
    >
      <input type="hidden" name="form-name" value="dcs-diagnostic" />

      <p class="sr-only" aria-hidden="true">
        <label>
          Do not fill:
          <input name="bot-field" tabindex="-1" autocomplete="off" />
        </label>
      </p>

      <label>
        Website
        <input name="website" type="url" autocomplete="url" required />
      </label>

      <label>
        Name
        <input name="name" type="text" autocomplete="name" required />
      </label>

      <label>
        Email
        <input name="email" type="email" autocomplete="email" required />
      </label>

      <button id="dcs-submit-btn" type="submit">Run Diagnostic</button>
      <div id="dcs-form-error" style="display:none;" role="status" aria-live="polite"></div>
    </form>

    <!-- Your existing page sections/content can remain below -->
    <!-- Section 1: Symptoms -->
    <section class="tier2-section" data-nt-section="symptoms" data-nt-track="nt_symptoms_view">
      <div class="tier2-container">
        <h1 class="tier2-h1">Your Marketing Isn't Broken. Your Credibility Is Invisible.</h1>
        <p class="tier2-lead">You've tried the agencies. You've spent on ads. You've published content. And yet:</p>
        <ul class="tier2-list tier2-list--dashes">
          <li>Your competitors appear in AI answers. You don't.</li>
          <li>Your ads cost more every quarter with diminishing returns.</li>
          <li>Your content ranks, but doesn't convert.</li>
          <li>You can't explain why some campaigns work and others fail.</li>
        </ul>
        <p>These aren't marketing problems. They're symptoms of something deeper.</p>
      </div>
    </section>

    <!-- Section 2: Reframing -->
    <section class="tier2-section tier2-section--alt" data-nt-section="reframing" data-nt-track="nt_reframing_view">
      <div class="tier2-container">
        <h2 class="tier2-h2">What's Actually Happening</h2>
        <p class="tier2-lead">The rules changed. Most businesses haven't noticed.</p>
        <p>Search engines and AI systems no longer just rank pages — they <strong>evaluate credibility</strong>.</p>
        <p>If your business isn’t structured for machine trust, you’re invisible to AI-driven discovery.</p>
        <p><strong>This isn’t SEO. It’s systemic credibility.</strong></p>
      </div>
    </section>

    <!-- Section 3: DCS Definition -->
    <section class="tier2-section" data-nt-section="dcs_definition" data-nt-track="nt_dcs_definition_view">
      <div class="tier2-container">
        <h2 class="tier2-h2">What the Digital Credibility Score Measures</h2>
        <p class="tier2-lead">DCS quantifies how machines perceive your business:</p>
        <div class="tier2-grid">
          <div class="tier2-card">
            <h3 class="tier2-h3">Structural Clarity</h3>
            <p>Can machines parse and understand your content?</p>
          </div>
          <div class="tier2-card">
            <h3 class="tier2-h3">Measurement Integrity</h3>
            <p>Is your telemetry deterministic and auditable?</p>
          </div>
          <div class="tier2-card">
            <h3 class="tier2-h3">Authority Signals</h3>
            <p>Do you demonstrate expertise through structure, not claims?</p>
          </div>
          <div class="tier2-card">
            <h3 class="tier2-h3">Trust Architecture</h3>
            <p>Does your site behave like a trustworthy system?</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Section 4: Telemetry -->
    <section class="tier2-section tier2-section--alt" data-nt-section="telemetry_value" data-nt-track="nt_telemetry_explainer_view">
      <div class="tier2-container">
        <h2 class="tier2-h2">Why Telemetry Matters</h2>
        <p class="tier2-lead">Analytics reports. Telemetry proves.</p>
        <ul class="tier2-list tier2-list--checks">
          <li>Attribute outcomes to actions</li>
          <li>Defend decisions with evidence</li>
          <li>Feed clean signals to AI systems</li>
          <li>Eliminate guesswork</li>
        </ul>
      </div>
    </section>

    <!-- Section 5: Outcomes -->
    <section class="tier2-section" data-nt-section="outcomes" data-nt-track="nt_outcomes_view">
      <div class="tier2-container">
        <h2 class="tier2-h2">What You Get</h2>
        <div class="tier2-grid">
          <div class="tier2-card tier2-card--accent">
            <h3 class="tier2-h3">Baseline Score</h3>
            <p>Your current credibility, quantified.</p>
          </div>
          <div class="tier2-card tier2-card--accent">
            <h3 class="tier2-h3">Gap Analysis</h3>
            <p>What’s missing or hurting you.</p>
          </div>
          <div class="tier2-card tier2-card--accent">
            <h3 class="tier2-h3">Priority Roadmap</h3>
            <p>What to fix first, and why.</p>
          </div>
          <div class="tier2-card tier2-card--accent">
            <h3 class="tier2-h3">Measurement Foundation</h3>
            <p>How to prove progress.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Section 6: CTA -->
    <section class="tier2-section tier2-section--cta" data-nt-section="diagnostic_cta" data-nt-track="nt_primary_cta_view">
      <div class="tier2-container">
        <h2 class="tier2-h2">Ready to See What Machines See?</h2>
        <p class="tier2-lead">15 minutes. No pitch. Just clarity.</p>
        <a
          href="#dcs-diagnostic-form"
          class="tier2-btn"
          data-nt-event="cta_primary"
          data-nt-cta-id="start_diagnostic"
          data-nt-cta-location="tier2_footer"
        >
          Start Your DCS Diagnostic
        </a>
      </div>
    </section>

    <!-- AJAX submit (prevents POST->/thank-you/ 404) -->
    <script is:inline>
      (function () {
        var form = document.getElementById("dcs-diagnostic-form");
        if (!form) return;

        var btn = document.getElementById("dcs-submit-btn");
        var err = document.getElementById("dcs-form-error");

        function getGtmPreviewQS() {
          var qs = window.location.search || "";
          if (!qs) return "";
          var hasPreview =
            qs.indexOf("gtm_debug=") !== -1 ||
            qs.indexOf("gtm_auth=") !== -1 ||
            qs.indexOf("gtm_preview=") !== -1;
          return hasPreview ? qs : "";
        }

        form.addEventListener("submit", function (e) {
          e.preventDefault();

          if (btn) btn.disabled = true;
          if (err) { err.style.display = "none"; err.textContent = ""; }

          // Netlify expects x-www-form-urlencoded
          var formData = new FormData(form);
          var body = new URLSearchParams();
          for (var pair of formData.entries()) body.append(pair[0], String(pair[1]));

          fetch("/", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: body.toString()
          })
            .then(function (res) {
              if (!res.ok) throw new Error("Netlify form submit failed: " + res.status);
              var qs = getGtmPreviewQS();
              window.location.assign("/dcs-diagnostic/thank-you/" + (qs || ""));
            })
            .catch(function (ex) {
              if (btn) btn.disabled = false;
              if (err) {
                err.textContent = "Submission failed. Please try again.";
                err.style.display = "block";
              }
              console.error(ex);
            });
        });
      })();
    </script>

    <!-- Tier-2 view telemetry (gated by nt_system_ready, session dedupe) -->
    <script is:inline>
      (function () {
        window.dataLayer = window.dataLayer || [];

        var TIMEOUT_MS = 3000;
        var POLL_MS = 50;
        var elapsed = 0;

        function once(key, fn) {
          try {
            if (sessionStorage.getItem(key)) return;
            sessionStorage.setItem(key, "1");
          } catch (e) {}
          fn();
        }

        function fire() {
          once("nt_dcs_diag_view", function () {
            window.dataLayer.push({
              event: "nt_dcs_diag_view",
              nt_event_source: "tier2",
              page_path: location.pathname,
              page_title: document.title
            });
          });
        }

        function hasSystemReady() {
          try {
            for (var i = window.dataLayer.length - 1; i >= 0; i--) {
              if (window
