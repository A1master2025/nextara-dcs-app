---
<<<<<<< HEAD
/**
 * src/pages/dcs-diagnostic.astro
 * Tier-2 DCS Diagnostic
 *
 * Critical behavior:
 * - Native form POST is intercepted (prevents POST->/thank-you/ 404 + GTM Preview drop)
 * - Netlify Forms submission via fetch("/") using x-www-form-urlencoded
 * - Redirect to /dcs-diagnostic/thank-you/ via GET (preserves GTM preview querystring)
 * - View telemetry: nt_dcs_diag_view (gated by nt_system_ready, session dedupe)
 */
import Layout from '../layouts/Layout.astro';
import Tier2Telemetry from '../components/Tier2Telemetry.astro';
---

<Layout>
  <main class="tier2-main" data-nt-page="dcs_diagnostic">
    <!-- DCS Diagnostic Form (Netlify Forms) -->
    <form
      id="dcs-diagnostic-form"
      name="dcs-diagnostic"
      method="POST"
      data-netlify="true"
      data-netlify-honeypot="bot-field"
      action="/dcs-diagnostic/thank-you/"
    >
      <input type="hidden" name="form-name" value="dcs-diagnostic" />

      <p class="sr-only" aria-hidden="true">
        <label>
          Do not fill:
          <input name="bot-field" tabindex="-1" autocomplete="off" />
        </label>
      </p>

      <label>
        Website
        <input name="website" type="url" autocomplete="url" required />
      </label>

      <label>
        Name
        <input name="name" type="text" autocomplete="name" required />
      </label>

      <label>
        Email
        <input name="email" type="email" autocomplete="email" required />
      </label>

      <button id="dcs-submit-btn" type="submit">Run Diagnostic</button>
      <div id="dcs-form-error" style="display:none;" role="status" aria-live="polite"></div>
    </form>

    <!-- Your existing page sections/content can remain below -->
    <!-- Section 1: Symptoms -->
    <section class="tier2-section" data-nt-section="symptoms" data-nt-track="nt_symptoms_view">
      <div class="tier2-container">
        <h1 class="tier2-h1">Your Marketing Isn't Broken. Your Credibility Is Invisible.</h1>
        <p class="tier2-lead">You've tried the agencies. You've spent on ads. You've published content. And yet:</p>
        <ul class="tier2-list tier2-list--dashes">
          <li>Your competitors appear in AI answers. You don't.</li>
          <li>Your ads cost more every quarter with diminishing returns.</li>
          <li>Your content ranks, but doesn't convert.</li>
          <li>You can't explain why some campaigns work and others fail.</li>
        </ul>
        <p>These aren't marketing problems. They're symptoms of something deeper.</p>
      </div>
=======
import Layout from "../layouts/Layout.astro";
import Tier2Telemetry from "../components/Tier2Telemetry.astro";
---

<Layout title="DCS Diagnostic | NexTara">
  <Tier2Telemetry />
  <main data-nt-section="diagnostic" data-nt-page="dcs_diagnostic">
    <section class="diagnostic-hero">
      <h1>DCS Diagnostic</h1>
      <p>Discover how your digital presence scores across credibility, trust, and machine readability.</p>
>>>>>>> 03a8149 ([fix]: DIOS-compliant form + thank-you with Tier2Telemetry)
    </section>

    <section class="diagnostic-form-section" data-nt-section="diagnostic_form">
      <form
        id="dcs-form"
        name="dcs-diagnostic"
        method="POST"
        data-netlify="true"
        data-netlify-honeypot="bot-field"
        action="/dcs-diagnostic/thank-you/"
        data-nt-form="dcs_diagnostic"
        data-nt-conversion="true"
      >
        <input type="hidden" name="form-name" value="dcs-diagnostic" />

        <p class="hidden" aria-hidden="true" style="display:none;">
          <label>
            Don't fill this out:
            <input name="bot-field" tabindex="-1" autocomplete="off" />
          </label>
        </p>

        <div class="form-field">
          <label for="dcs-website">Website</label>
          <input
            type="url"
            id="dcs-website"
            name="website"
            autocomplete="url"
            required
            placeholder="https://yourwebsite.com"
            data-nt-field="website"
          />
        </div>

        <div class="form-field">
          <label for="dcs-name">Name</label>
          <input
            type="text"
            id="dcs-name"
            name="name"
            autocomplete="name"
            required
            placeholder="Your name"
            data-nt-field="name"
          />
        </div>

        <div class="form-field">
          <label for="dcs-email">Email</label>
          <input
            type="email"
            id="dcs-email"
            name="email"
            autocomplete="email"
            required
            placeholder="you@example.com"
            data-nt-field="email"
          />
        </div>

        <div id="dcs-form-error" class="form-error" style="display:none;" role="alert"></div>

        <button
          type="submit"
          id="dcs-submit-btn"
          data-nt-event="cta_conversion"
          data-nt-cta="dcs_diagnostic_submit"
        >
          Run Diagnostic
        </button>
      </form>
    </section>
<<<<<<< HEAD

    <!-- AJAX submit (prevents POST->/thank-you/ 404) -->
    <script is:inline>
      (function () {
        var form = document.getElementById("dcs-diagnostic-form");
        if (!form) return;

        var btn = document.getElementById("dcs-submit-btn");
        var err = document.getElementById("dcs-form-error");

        function getGtmPreviewQS() {
          var qs = window.location.search || "";
          if (!qs) return "";
          var hasPreview =
            qs.indexOf("gtm_debug=") !== -1 ||
            qs.indexOf("gtm_auth=") !== -1 ||
            qs.indexOf("gtm_preview=") !== -1;
          return hasPreview ? qs : "";
        }

        form.addEventListener("submit", function (e) {
          e.preventDefault();

          if (btn) btn.disabled = true;
          if (err) { err.style.display = "none"; err.textContent = ""; }

          // Netlify expects x-www-form-urlencoded
          var formData = new FormData(form);
          var body = new URLSearchParams();
          for (var pair of formData.entries()) body.append(pair[0], String(pair[1]));

          fetch("/", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: body.toString()
          })
            .then(function (res) {
              if (!res.ok) throw new Error("Netlify form submit failed: " + res.status);
              var qs = getGtmPreviewQS();
              window.location.assign("/dcs-diagnostic/thank-you/" + (qs || ""));
            })
            .catch(function (ex) {
              if (btn) btn.disabled = false;
              if (err) {
                err.textContent = "Submission failed. Please try again.";
                err.style.display = "block";
              }
              console.error(ex);
            });
        });
      })();
    </script>

    <!-- Tier-2 view telemetry (gated by nt_system_ready, session dedupe) -->
    <script is:inline>
      (function () {
        window.dataLayer = window.dataLayer || [];

        var TIMEOUT_MS = 3000;
        var POLL_MS = 50;
        var elapsed = 0;

        function once(key, fn) {
          try {
            if (sessionStorage.getItem(key)) return;
            sessionStorage.setItem(key, "1");
          } catch (e) {}
          fn();
        }

        function fire() {
          once("nt_dcs_diag_view", function () {
            window.dataLayer.push({
              event: "nt_dcs_diag_view",
              nt_event_source: "tier2",
              page_path: location.pathname,
              page_title: document.title
            });
          });
        }

        function hasSystemReady() {
          try {
            for (var i = window.dataLayer.length - 1; i >= 0; i--) {
              if (window
=======
  </main>
</Layout>

<script is:inline>
(function() {
  var SESSION_KEY = "nt_dcs_diag_view_fired";

  function isSystemReady() {
    if (window.__NT_SYSTEM_READY_EMITTED__ === true) return true;
    if (window.dataLayer && Array.isArray(window.dataLayer)) {
      for (var i = 0; i < window.dataLayer.length; i++) {
        if (window.dataLayer[i] && window.dataLayer[i].event === "nt_system_ready") {
          return true;
        }
      }
    }
    return false;
  }

  function pushViewEvent() {
    if (typeof sessionStorage !== "undefined" && sessionStorage.getItem(SESSION_KEY)) {
      return;
    }
    if (window.dataLayer) {
      window.dataLayer.push({
        event: "nt_dcs_diag_view",
        nt_event_source: "tier2",
        page_path: "/dcs-diagnostic/"
      });
      if (typeof sessionStorage !== "undefined") {
        sessionStorage.setItem(SESSION_KEY, "1");
      }
    }
  }

  function waitForReady() {
    if (isSystemReady()) {
      pushViewEvent();
      return;
    }
    var attempts = 0;
    var maxAttempts = 30;
    var interval = setInterval(function() {
      attempts++;
      if (isSystemReady()) {
        clearInterval(interval);
        pushViewEvent();
      } else if (attempts >= maxAttempts) {
        clearInterval(interval);
        pushViewEvent();
      }
    }, 100);
  }

  if (document.readyState === "complete") {
    waitForReady();
  } else {
    window.addEventListener("load", waitForReady);
  }
})();
</script>

<script is:inline>
(function() {
  var form = document.getElementById("dcs-form");
  var submitBtn = document.getElementById("dcs-submit-btn");
  var errorDiv = document.getElementById("dcs-form-error");

  if (!form) return;

  form.addEventListener("submit", function(e) {
    e.preventDefault();

    var formData = new FormData(form);
    submitBtn.disabled = true;
    submitBtn.textContent = "Submitting...";
    errorDiv.style.display = "none";

    fetch("/", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams(formData).toString()
    })
    .then(function(response) {
      if (!response.ok) {
        throw new Error("Network response was not ok");
      }
      var thankYouPath = "/dcs-diagnostic/thank-you/";
      var params = new URLSearchParams(window.location.search);
      var gtmParams = [];
      if (params.get("gtm_debug")) gtmParams.push("gtm_debug=" + encodeURIComponent(params.get("gtm_debug")));
      if (params.get("gtm_auth")) gtmParams.push("gtm_auth=" + encodeURIComponent(params.get("gtm_auth")));
      if (params.get("gtm_preview")) gtmParams.push("gtm_preview=" + encodeURIComponent(params.get("gtm_preview")));
      if (gtmParams.length > 0) {
        thankYouPath += "?" + gtmParams.join("&");
      }
      window.location.assign(thankYouPath);
    })
    .catch(function(error) {
      submitBtn.disabled = false;
      submitBtn.textContent = "Run Diagnostic";
      errorDiv.textContent = "Submission failed. Please try again.";
      errorDiv.style.display = "block";
      console.error("Form submission error:", error);
    });
  });
})();
</script>
>>>>>>> 03a8149 ([fix]: DIOS-compliant form + thank-you with Tier2Telemetry)
